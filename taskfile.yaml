version: "3"

vars:
  HOST: "[::1]"
  PORT: "50051"
  SERVER_LIFETIME: "10"

env:
  PYO3_PYTHON: '{{if eq OS "windows"}}{{.USER_WORKING_DIR}}\\.venv\\Scripts\\python.exe{{else}}.venv/bin/python{{end}}'

tasks:
  generate:
    desc: Generate gRPC code
    sources:
      - protos/**
      - Cargo.toml
      - rust/**
      - python/**
      - pyproject.toml
    cmds:
      - uv run -m grpc_tools.protoc --proto_path=./protos --python_out=./python/client/src/client --pyi_out=./python/client/src/client --grpc_python_out=./python/client/src/client ./protos/teacher.proto
      - sed -i 's/^\(import.*_pb2\)/from . \1/' python/client/src/client/teacher_pb2_grpc.py
      - cargo build --release
  
  python-checks:
    desc: Run Python type and lint checks
    sources:
      - pyproject.toml
      - python/**
    cmds:
      - uv run mypy .
      - uv run ruff check --fix
      - uv run pyright

  rust-checks:
    desc: Run Rust checks
    sources:
      - Cargo.toml
      - rust/**
    cmds:
      - cargo check
      - cargo fmt --check
      - cargo clippy --all-targets --all-features -- -D warnings

  python-client:
    desc: Run Python gRPC client
    vars:
      HOST: "{{.HOST}}"
      PORT: "{{.PORT}}"
      OPERATION: "{{.OPERATION | default \"Add\"}}"
      NUMS: "{{.NUMS | default \"5 3\"}}"
    cmds:
      - uv run -m client --host {{.HOST}} --port {{.PORT}} --operation {{.OPERATION}} --numbers {{.NUMS}}
  
  rust-server:
    desc: Run Rust gRPC server
    vars:
      HOST: "{{.HOST}}"
      PORT: "{{.PORT}}"
    cmds:
      - cargo run --release --bin server -- --host {{.HOST}} --port {{.PORT}}

  rust-server-bg:
    desc: Run Rust gRPC server in the background
    vars:
      HOST: "{{.HOST}}"
      PORT: "{{.PORT}}"
    cmds:
      - cargo run --release --bin server -- --host {{.HOST}} --port {{.PORT}} &
  
  rust-server-sleep:
    desc: Run Rust gRPC server for a limited time
    vars:
      HOST: "{{.HOST}}"
      PORT: "{{.PORT}}"
    cmds:
      - task: rust-server-bg
      - sleep {{.SERVER_LIFETIME}}
      - pkill -f target/release/server

  test-multiple-python-clients:
    desc: Run both server and client for testing
    vars:
      HOST: "{{.HOST}}"
      PORT: "{{.PORT}}"
      OPERATION: "{{.OPERATION | default \"Add\"}}"
      NUMS: "{{.NUMS | default \"5 3\"}}"
    cmds:
      - task: rust-server-bg
      - sleep 1
      - |
        for i in {1..100}; do
          task python-client &
        done
        sleep 30
      - pkill -f target/release/server